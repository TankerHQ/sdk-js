include:
  - project: TankerHQ/gitlab-ci-files
    file: /common.yml
    ref: 2021-11-10-229

stages:
  - check
  - bridge-check
  - bench
  - deploy

default:
  image: registry.gitlab.com/tankerhq/docker/node:latest
  before_script:
    - poetry -V
    - node -v
    - poetry install
    - poetry run python --version

check/lint:
  stage: check
  rules:
    - !reference [.rules/mr/auto, rules]
    - !reference [.rules/web/auto, rules]
    - !reference [.rules/push-master-or-feat, rules]
    - !reference [.rules/nightly, rules]
  script:
    - poetry run black --check run-ci.py
    - poetry run flake8 run-ci.py
    - poetry run mypy
    - poetry run isort --profile black --check --diff run-ci.py
    - poetry run python run-ci.py lint
  tags:
    - linux

check/linux/chrome:
  stage: check
  rules:
    - !reference [.rules/mr/auto, rules]
    - !reference [.rules/web/auto, rules]
    - !reference [.rules/push-master-or-feat, rules]
  script:
    - poetry run python run-ci.py check --runner linux
  tags:
    - linux

.check/linux/node-base:
  stage: check
  script:
    - /usr/local/nvm/nvm-exec poetry run python run-ci.py check --runner node
    - mv coverage/lcov-report lcov-report
  artifacts:
    paths:
      - lcov-report/
    expire_in: 7 days
  tags:
    - linux

check/linux/node:
  extends:
    - .check/linux/node-base
  rules:
    - !reference [.rules/mr/auto, rules]
    - !reference [.rules/web/auto, rules]
    - !reference [.rules/push-master-or-feat, rules]
    - !reference [.rules/nightly, rules]
  variables:
    NODE_VERSION: 16

check/linux/node-lts-old:
  extends:
    - .check/linux/node-base
  rules:
    - !reference [.rules/push-master, rules]
    - !reference [.rules/mr/manual, rules]
    - !reference [.rules/nightly, rules]
  variables:
    NODE_VERSION: 12

check/linux/node-lts:
  extends:
    - .check/linux/node-base
  rules:
    - !reference [.rules/push-master, rules]
    - !reference [.rules/mr/manual, rules]
    - !reference [.rules/nightly, rules]
  variables:
    NODE_VERSION: 14

check/linux/node-next:
  extends:
    - .check/linux/node-base
  rules:
    - !reference [.rules/push-master, rules]
    - !reference [.rules/mr/manual, rules]
    - !reference [.rules/nightly, rules]
  variables:
    NODE_VERSION: 17

check/macos:
  stage: check
  rules:
    - !reference [.rules/mr/auto, rules]
    - !reference [.rules/web/auto, rules]
    - !reference [.rules/push-master-or-feat, rules]
  script:
    - poetry run python run-ci.py check --runner macos
  tags:
    - macos
    - MacOSSlave-2

check/macos/nightly:
  stage: check
  extends: .rules/nightly
  script:
    - poetry run python run-ci.py check --runner macos --nightly
  tags:
    - macos
    - MacOSSlave-2
  timeout: 2h

.check/windows:
  stage: check
  tags:
    - windows
    - tanker

check/windows/edge:
  extends:
    - .check/windows
  rules:
    - !reference [.rules/mr/auto, rules]
    - !reference [.rules/web/auto, rules]
    - !reference [.rules/push-master-or-feat, rules]
    - !reference [.rules/nightly, rules]
  script:
    - poetry run python run-ci.py check --runner windows-edge

check/windows/ie:
  extends:
    - .check/windows
  rules:
    - !reference [.rules/push-master, rules]
    - !reference [.rules/nightly, rules]
    - !reference [.rules/mr/manual, rules]
  script:
    - poetry run python run-ci.py check --runner windows-ie

check/linux/nightly:
  extends:
    - .rules/nightly
  stage: check
  script:
    - poetry run python run-ci.py check --runner linux --nightly
  tags:
    - linux

# Benchmark jobs are pinned on a machine to have more consistent results.

.bench/common:
  extends: .variables/bridge-common
  stage: bench
  needs: []
  variables:
    UPSTREAM_MERGE_REQUEST_IID: $CI_MERGE_REQUEST_IID
    UPSTREAM_COMMIT_SHA: $CI_COMMIT_SHA
    UPSTREAM_COMMIT_REF_NAME: $CI_COMMIT_REF_NAME
  trigger:
    project: TankerHQ/benchmarks
    strategy: depend

.rules/bench:
  rules:
    - !reference [.rules/mr/manual, rules]

bench/linux:
  extends:
    - .bench/common
    - .rules/bench
  variables:
    UPSTREAM_JOB_TARGET: linux

bench/macos:
  extends:
    - .bench/common
    - .rules/bench
  variables:
    UPSTREAM_JOB_TARGET: macos

bench/windows:
  extends:
    - .bench/common
    - .rules/bench
  variables:
    UPSTREAM_JOB_TARGET: windows

pages:
  extends: 
    - .rules/push-master-or-feat
  stage: deploy
  needs:
    - check/linux/node
  script:
    - mv lcov-report/ public/
  artifacts:
    paths:
      - public
    expire_in: 7 days
  tags:
    - linux
  variables:
    GIT_STRATEGY: none

bridge/compat:
  stage: bridge-check
  extends:
    - .variables/bridge-common
  rules:
    - !reference [.rules/mr/auto, rules]
    - !reference [.rules/web/auto, rules]
  needs:
    - check/linux/node
  trigger:
    project: TankerHQ/compatibility-tests
    strategy: depend

check/e2e:
  stage: check
  rules:
    - !reference [.rules/mr/manual, rules]
    - !reference [.rules/nightly, rules]
  script:
    - poetry run python run-ci.py e2e
  tags:
    - linux
    - tanker
  image: registry.gitlab.com/tankerhq/docker/e2e:latest

audit:
  extends:
    - .rules/nightly
  stage: check
  script:
    - yarn
    - yarn audit
  tags:
    - linux

deploy:
  stage: deploy
  extends:
    - .rules/deploy/js
    - .tags/linux
  script:
    - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > "${HOME}/.npmrc"
    - poetry run python run-ci.py deploy --version "${SDK_JS_RELEASE_VERSION}"
  release:
    description: sdk-js v${SDK_JS_RELEASE_VERSION}
    tag_name: v${SDK_JS_RELEASE_VERSION}

test/deployed:
  stage: deploy
  needs:
    - deploy
  extends:
    - .rules/deploy/js
    - .tags/linux
  script:
    - poetry run python run-ci.py test-deploy --version "${SDK_JS_RELEASE_VERSION}"
