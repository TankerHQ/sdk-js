include:
  - project: TankerHQ/gitlab-ci-files
    file: /common.yml
    ref: 2021-12-16-236

stages:
  - check
  - bridge-check
  - bench
  - deploy

default:
  image: registry.gitlab.com/tankerhq/docker/node:latest
  before_script:
    - poetry -V
    - node -v
    - poetry install
    - poetry run python --version

check/lint:
  stage: check
  rules:
    - !reference [.rules/mr/auto, rules]
    - !reference [.rules/web/auto, rules]
    - !reference [.rules/push-master-or-feat, rules]
    - !reference [.rules/nightly, rules]
  script:
    - poetry run black --check run-ci.py
    - poetry run flake8 run-ci.py
    - poetry run mypy
    - poetry run isort --profile black --check --diff run-ci.py
    - poetry run python run-ci.py lint
  tags: !reference [.tags/linux, tags]

deploy:
  stage: deploy
  extends:
    - .rules/deploy/js
  script:
    - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > "${HOME}/.npmrc"
    - poetry run python run-ci.py deploy --version "${SDK_JS_RELEASE_VERSION}"
  release:
    description: sdk-js v${SDK_JS_RELEASE_VERSION}
    tag_name: v${SDK_JS_RELEASE_VERSION}
  tags: !reference [.tags/linux, tags]

test/deployed:
  stage: deploy
  needs:
    - deploy
  extends:
    - .rules/deploy/js
  script:
    - poetry run python run-ci.py test-deploy --version "${SDK_JS_RELEASE_VERSION}"
  tags: !reference [.tags/linux, tags]
